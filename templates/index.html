<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .leaflet-container {
            background: #374151;
        }

        /* Dark grey for map background */
        .leaflet-tooltip {
            background-color: rgba(31, 41, 55, 0.9);
            color: white;
            border: 1px solid #4b5563;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-radius: 6px;
        }

        .flight-route-tooltip {
            background-color: rgba(31, 41, 55, 0.95) !important;
            border: 1px solid #6b7280 !important;
            border-radius: 8px !important;
            padding: 8px !important;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-200 antialiased">

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-white tracking-tight">Flight Dashboard</h1>
            <p class="text-gray-400 mt-1">An overview of all scanned boarding passes.</p>
        </header>

        <main>
            <!-- Map Section -->
            <section id="map-section" class="mb-8">
                <h2 class="text-2xl font-semibold text-white mb-4">Flight Map</h2>
                <div id="flightMap" class="w-full h-96 md:h-[500px] bg-gray-700 rounded-lg shadow-lg"></div>
            </section>

            <!-- Table Section -->
            <section id="table-section">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-white">All Flights ({{ flights|length }})</h2>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="openAddImageModal()"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">
                            Add via Image
                        </button>
                        <button onclick="openCameraModal()"
                            class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            Scan Pass
                        </button>
                        <button onclick="openRawDataModal()"
                            class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                            </svg>
                            Enter Raw Data
                        </button>
                        <button onclick="openAddTripModal()"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">Add
                            Trip Manually</button>
                    </div>
                </div>
                <div class="bg-gray-800 rounded-lg shadow-lg overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-700">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                    Date</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                    Flight</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                    Route</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider hidden md:table-cell">
                                    Seat</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider hidden sm:table-cell">
                                    Confirmation</th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-gray-800 divide-y divide-gray-700">
                            {% for flight in flights %}
                            <tr id="flight-row-{{ flight.id }}"
                                class="hover:bg-gray-700/50 transition-colors duration-200 {% if flight.is_skiplagged %} text-gray-500 opacity-60 {% endif %}">
                                <td class="px-6 py-4 whitespace-nowrap">{{ flight.departure_date }}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="font-medium text-white">{{ flight.carrier }} {{ flight.flight_number }}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <span class="font-mono bg-gray-700 text-gray-200 px-2 py-1 rounded-md">{{
                                            flight.origin }}</span>
                                        <span class="mx-2 text-gray-500">→</span>
                                        <span class="font-mono bg-gray-700 text-gray-200 px-2 py-1 rounded-md">{{
                                            flight.destination }}</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap hidden md:table-cell">{{ flight.seat_number }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap hidden sm:table-cell font-mono">{{
                                    flight.confirmation_number }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-right">
                                    <button onclick="openModal('{{ flight.id }}')"
                                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">Details</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Source Viewer Modal (for raw data or image) -->
    <div id="source-modal-backdrop"
        class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-[1002] transition-opacity duration-300"
        onclick="closeSourceModal()">
        <div id="source-modal"
            class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-2xl m-4 transform transition-all duration-300 scale-95 opacity-0 max-h-[90vh] overflow-y-auto"
            onclick="event.stopPropagation()">
            <!-- Modal content will be injected here -->
        </div>
    </div>

    <!-- Details Modal -->
    <div id="details-modal-backdrop"
        class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-[1000] transition-opacity duration-300"
        onclick="closeModal()">
        <div id="details-modal"
            class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-lg m-4 transform transition-all duration-300 scale-95 opacity-0"
            onclick="event.stopPropagation()">
            <!-- Modal content will be injected here -->
        </div>
    </div>

    <!-- Manual Add Trip Modal -->
    <div id="add-trip-modal-backdrop"
        class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-[1000] transition-opacity duration-300"
        onclick="closeAddTripModal()">
        <div id="add-trip-modal"
            class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-lg m-4 transform transition-all duration-300 scale-95 opacity-0"
            onclick="event.stopPropagation()">
            <form id="add-trip-form" onsubmit="handleAddTripSubmit(event)" class="p-6">
                <div class="flex justify-between items-start mb-6">
                    <h3 class="text-2xl font-bold text-white">Add a New Trip</h3>
                    <button type="button" onclick="closeAddTripModal()"
                        class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="passenger_name" class="block text-sm font-medium text-gray-300">Passenger
                                Name</label>
                            <input type="text" name="passenger_name" value="LIVINGSTON/LIAM" required
                                class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="confirmation_number"
                                class="block text-sm font-medium text-gray-300">Confirmation #</label>
                            <input type="text" name="confirmation_number"
                                class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                maxlength="7" style="text-transform:uppercase">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="carrier" class="block text-sm font-medium text-gray-300">Airline (IATA)</label>
                            <input type="text" name="carrier" required
                                class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                maxlength="2" style="text-transform:uppercase">
                        </div>
                        <div>
                            <label for="flight_number" class="block text-sm font-medium text-gray-300">Flight
                                Number</label>
                            <input type="text" name="flight_number" required
                                class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div>
                        <label for="seat_number" class="block text-sm font-medium text-gray-300">Seat</label>
                        <input type="text" name="seat_number"
                            class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                            style="text-transform:uppercase">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="origin" class="block text-sm font-medium text-gray-300">Origin (IATA)</label>
                            <input type="text" name="origin" required
                                class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                maxlength="3" style="text-transform:uppercase">
                        </div>
                        <div>
                            <label for="destination" class="block text-sm font-medium text-gray-300">Destination
                                (IATA)</label>
                            <input type="text" name="destination" required
                                class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                maxlength="3" style="text-transform:uppercase">
                        </div>
                    </div>
                    <div>
                        <label for="flightera_link" class="block text-sm font-medium text-gray-300">Flightera
                            Link</label>
                        <div class="flex gap-2">
                            <input type="url" name="flightera_link" id="flightera_link"
                                class="flex-1 bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <button type="button" onclick="autoScrapeFlightera()"
                                class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 whitespace-nowrap">Auto
                                Fill</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="scheduled_departure_time"
                                class="block text-sm font-medium text-gray-300">Scheduled Departure</label>
                            <input type="datetime-local" name="scheduled_departure_time"
                                class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="actual_departure_time" class="block text-sm font-medium text-gray-300">Actual
                                Departure</label>
                            <input type="datetime-local" name="actual_departure_time"
                                class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="scheduled_arrival_time"
                                class="block text-sm font-medium text-gray-300">Scheduled Arrival</label>
                            <input type="datetime-local" name="scheduled_arrival_time"
                                class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="actual_arrival_time" class="block text-sm font-medium text-gray-300">Actual
                                Arrival</label>
                            <input type="datetime-local" name="actual_arrival_time"
                                class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div>
                        <label for="cabin" class="block text-sm font-medium text-gray-300">Cabin</label>
                        <select name="cabin"
                            class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option>Economy</option>
                            <option>Premium Economy</option>
                            <option>Business</option>
                            <option>First</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6 pt-4 border-t border-gray-700 flex justify-end">
                    <button type="button" onclick="closeAddTripModal()"
                        class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 mr-2">Cancel</button>
                    <button type="submit"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">Add
                        Flight</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Flightera Update Modal -->
    <div id="flightera-update-modal-backdrop"
        class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-[1001] transition-opacity duration-300"
        onclick="closeFlighteraUpdateModal()">
        <div id="flightera-update-modal"
            class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-lg m-4 transform transition-all duration-300 scale-95 opacity-0"
            onclick="event.stopPropagation()">
            <form id="flightera-update-form" onsubmit="handleFlighteraUpdateSubmit(event)" class="p-6">
                <input type="hidden" name="flight_id" id="flightera-update-flight-id">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h3 class="text-2xl font-bold text-white">Add Flightera Data</h3>
                        <p id="flightera-update-flight-info" class="text-gray-400 mt-1"></p>
                    </div>
                    <button type="button" onclick="closeFlighteraUpdateModal()"
                        class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="flightera_update_link" class="block text-sm font-medium text-gray-300">Flightera
                            Link</label>
                        <div class="flex gap-2 mt-1">
                            <input type="url" name="flightera_link" id="flightera_update_link"
                                placeholder="https://www.flightera.net/en/flight_details/..."
                                class="flex-1 bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <button type="button" onclick="autoScrapeFlighteraUpdate()" id="flightera-scrape-btn"
                                class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 whitespace-nowrap">Pull
                                Data</button>
                        </div>
                    </div>
                    <div id="flightera-scraped-data" class="hidden space-y-4">
                        <div class="bg-gray-700 p-3 rounded-md">
                            <p class="text-sm text-green-400 mb-2">✓ Data pulled successfully. Review and edit as
                                needed:</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="flightera_scheduled_departure_time"
                                    class="block text-sm font-medium text-gray-300">Scheduled Departure</label>
                                <input type="datetime-local" name="scheduled_departure_time"
                                    id="flightera_scheduled_departure_time"
                                    class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="flightera_actual_departure_time"
                                    class="block text-sm font-medium text-gray-300">Actual Departure</label>
                                <input type="datetime-local" name="actual_departure_time"
                                    id="flightera_actual_departure_time"
                                    class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div>
                            <label for="flightera_dep_timezone"
                                class="block text-sm font-medium text-gray-300">Departure Timezone (UTC offset)</label>
                            <select name="dep_timezone" id="flightera_dep_timezone"
                                class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option value="-12:00">UTC-12:00</option>
                                <option value="-11:00">UTC-11:00</option>
                                <option value="-10:00">UTC-10:00 (HST)</option>
                                <option value="-09:00">UTC-09:00 (AKST)</option>
                                <option value="-08:00">UTC-08:00 (PST)</option>
                                <option value="-07:00">UTC-07:00 (MST)</option>
                                <option value="-06:00">UTC-06:00 (CST)</option>
                                <option value="-05:00">UTC-05:00 (EST)</option>
                                <option value="-04:00">UTC-04:00 (AST)</option>
                                <option value="-03:00">UTC-03:00</option>
                                <option value="-02:00">UTC-02:00</option>
                                <option value="-01:00">UTC-01:00</option>
                                <option value="+00:00" selected>UTC+00:00 (GMT)</option>
                                <option value="+01:00">UTC+01:00 (CET)</option>
                                <option value="+02:00">UTC+02:00 (EET)</option>
                                <option value="+03:00">UTC+03:00 (MSK)</option>
                                <option value="+04:00">UTC+04:00 (GST)</option>
                                <option value="+05:00">UTC+05:00</option>
                                <option value="+05:30">UTC+05:30 (IST)</option>
                                <option value="+06:00">UTC+06:00</option>
                                <option value="+07:00">UTC+07:00 (ICT)</option>
                                <option value="+08:00">UTC+08:00 (SGT/HKT)</option>
                                <option value="+09:00">UTC+09:00 (JST/KST)</option>
                                <option value="+10:00">UTC+10:00 (AEST)</option>
                                <option value="+11:00">UTC+11:00</option>
                                <option value="+12:00">UTC+12:00 (NZST)</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="flightera_scheduled_arrival_time"
                                    class="block text-sm font-medium text-gray-300">Scheduled Arrival</label>
                                <input type="datetime-local" name="scheduled_arrival_time"
                                    id="flightera_scheduled_arrival_time"
                                    class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="flightera_actual_arrival_time"
                                    class="block text-sm font-medium text-gray-300">Actual Arrival</label>
                                <input type="datetime-local" name="actual_arrival_time"
                                    id="flightera_actual_arrival_time"
                                    class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div>
                            <label for="flightera_arr_timezone" class="block text-sm font-medium text-gray-300">Arrival
                                Timezone (UTC offset)</label>
                            <select name="arr_timezone" id="flightera_arr_timezone"
                                class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option value="-12:00">UTC-12:00</option>
                                <option value="-11:00">UTC-11:00</option>
                                <option value="-10:00">UTC-10:00 (HST)</option>
                                <option value="-09:00">UTC-09:00 (AKST)</option>
                                <option value="-08:00">UTC-08:00 (PST)</option>
                                <option value="-07:00">UTC-07:00 (MST)</option>
                                <option value="-06:00">UTC-06:00 (CST)</option>
                                <option value="-05:00">UTC-05:00 (EST)</option>
                                <option value="-04:00">UTC-04:00 (AST)</option>
                                <option value="-03:00">UTC-03:00</option>
                                <option value="-02:00">UTC-02:00</option>
                                <option value="-01:00">UTC-01:00</option>
                                <option value="+00:00" selected>UTC+00:00 (GMT)</option>
                                <option value="+01:00">UTC+01:00 (CET)</option>
                                <option value="+02:00">UTC+02:00 (EET)</option>
                                <option value="+03:00">UTC+03:00 (MSK)</option>
                                <option value="+04:00">UTC+04:00 (GST)</option>
                                <option value="+05:00">UTC+05:00</option>
                                <option value="+05:30">UTC+05:30 (IST)</option>
                                <option value="+06:00">UTC+06:00</option>
                                <option value="+07:00">UTC+07:00 (ICT)</option>
                                <option value="+08:00">UTC+08:00 (SGT/HKT)</option>
                                <option value="+09:00">UTC+09:00 (JST/KST)</option>
                                <option value="+10:00">UTC+10:00 (AEST)</option>
                                <option value="+11:00">UTC+11:00</option>
                                <option value="+12:00">UTC+12:00 (NZST)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="mt-6 pt-4 border-t border-gray-700 flex justify-end">
                    <button type="button" onclick="closeFlighteraUpdateModal()"
                        class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 mr-2">Cancel</button>
                    <button type="submit" id="flightera-save-btn"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Image Modal -->
    <div id="add-image-modal-backdrop"
        class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-[1000] transition-opacity duration-300"
        onclick="closeAddImageModal()">
        <div id="add-image-modal"
            class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-4xl m-4 transform transition-all duration-300 scale-95 opacity-0 flex flex-col max-h-[90vh]"
            onclick="event.stopPropagation()">

            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white">Add Flight from Image</h3>
                <button type="button" onclick="closeAddImageModal()"
                    class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>

            <div class="p-6 flex-1 overflow-y-auto">
                <div id="upload-step-1" class="space-y-4">
                    <div class="border-2 border-dashed border-gray-600 rounded-lg p-8 text-center"
                        ondrop="handleDrop(event)" ondragover="event.preventDefault()">
                        <p class="text-gray-300 mb-4">Drag and drop boarding pass images here, or click to select.</p>
                        <input type="file" id="image-input" accept="image/*" multiple class="hidden"
                            onchange="handleFileSelect(event)">
                        <button onclick="document.getElementById('image-input').click()"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md transition-colors duration-200">
                            Select Images
                        </button>
                    </div>
                </div>

                <div id="upload-step-2" class="hidden h-full flex flex-col">
                    <div class="mb-4 flex justify-between items-center">
                        <span class="text-gray-300">Processing image <span id="current-image-num">1</span> of <span
                                id="total-images-num">1</span></span>
                        <div class="flex gap-2">
                            <button onclick="skipCurrentImage()"
                                class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded-md transition-colors duration-200 text-sm">
                                Skip
                            </button>
                        </div>
                    </div>

                    <!-- Error Message Container -->
                    <div id="upload-error-msg"
                        class="hidden mb-4 bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded relative"
                        role="alert">
                        <span class="block sm:inline" id="upload-error-text"></span>
                    </div>

                    <div class="flex-1 bg-gray-900 rounded-lg overflow-hidden relative min-h-[400px]">
                        <img id="cropper-image" src="" alt="To Crop" class="max-w-full">
                    </div>

                    <div class="mt-4 flex justify-end">
                        <button onclick="processCurrentImage()"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-md transition-colors duration-200 flex items-center">
                            <span id="process-btn-text">Crop & Parse</span>
                            <div id="process-spinner"
                                class="hidden ml-2 w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin">
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="camera-modal-backdrop"
        class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-[1000] transition-opacity duration-300"
        onclick="closeCameraModal()">
        <div id="camera-modal"
            class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-lg m-4 transform transition-all duration-300 scale-95 opacity-0"
            onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xl font-bold text-white">Scan Boarding Pass</h3>
                    <button type="button" onclick="closeCameraModal()"
                        class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                </div>
                <div id="reader" width="600px" class="bg-black rounded-lg overflow-hidden"></div>
                <p class="text-gray-400 mt-4 text-sm text-center">Point your camera at the barcode (Aztec or QR code).
                </p>
            </div>
        </div>
    </div>

    <!-- Raw Data Entry Modal -->
    <div id="raw-data-modal-backdrop"
        class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-[1000] transition-opacity duration-300"
        onclick="closeRawDataModal()">
        <div id="raw-data-modal"
            class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-lg m-4 transform transition-all duration-300 scale-95 opacity-0"
            onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-xl font-bold text-white">Enter Raw Barcode Data</h3>
                        <p class="text-gray-400 text-sm mt-1">Paste the raw BCBP data from your external scanner.</p>
                    </div>
                    <button type="button" onclick="closeRawDataModal()"
                        class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                </div>

                <!-- Error Message Container -->
                <div id="raw-data-error-msg"
                    class="hidden mb-4 bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded relative"
                    role="alert">
                    <span class="block sm:inline" id="raw-data-error-text"></span>
                </div>

                <!-- Success Message Container -->
                <div id="raw-data-success-msg"
                    class="hidden mb-4 bg-green-900/50 border border-green-500 text-green-200 px-4 py-3 rounded relative"
                    role="alert">
                    <span class="block sm:inline" id="raw-data-success-text"></span>
                </div>

                <form id="raw-data-form" onsubmit="handleRawDataSubmit(event)">
                    <div class="mb-4">
                        <label for="raw-data-input" class="block text-sm font-medium text-gray-300 mb-2">Raw BCBP
                            String</label>
                        <textarea id="raw-data-input" name="raw_data" rows="6"
                            placeholder="M1LIVINGSTON/LIAM       EUATPDLAS DL 1234 175Y018D0012 35D>..."
                            class="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-3 px-4 text-white font-mono text-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500 resize-none"
                            required></textarea>
                        <p class="text-gray-500 text-xs mt-1">This is the raw string encoded in the barcode (Aztec,
                            PDF417, or QR code).</p>
                    </div>

                    <div class="flex justify-end gap-2">
                        <button type="button" onclick="closeRawDataModal()"
                            class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">
                            Cancel
                        </button>
                        <button type="submit" id="raw-data-submit-btn"
                            class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-6 rounded-md transition-colors duration-200 flex items-center">
                            <span id="raw-data-btn-text">Process Data</span>
                            <div id="raw-data-spinner"
                                class="hidden ml-2 w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin">
                            </div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script id="flights-data" type="application/json">
        {{ flights | tojson | safe }}
    </script>
    <script>
        const flightsData = JSON.parse(document.getElementById('flights-data').textContent);
        let map;
        let flightLayers = [];

        // --- Great Circle Calculation ---
        function getGreatCircleArc(startCoords, endCoords, numPoints = 100) {
            const [startLat, startLon] = startCoords;
            const [endLat, endLon] = endCoords;

            const toRadians = deg => deg * Math.PI / 180;
            const toDegrees = rad => rad * 180 / Math.PI;

            const lat1 = toRadians(startLat);
            const lon1 = toRadians(startLon);
            const lat2 = toRadians(endLat);
            const lon2 = toRadians(endLon);

            const d = 2 * Math.asin(Math.sqrt(Math.pow(Math.sin((lat1 - lat2) / 2), 2) +
                Math.cos(lat1) * Math.cos(lat2) * Math.pow(Math.sin((lon1 - lon2) / 2), 2)));

            if (Math.abs(d) < 1e-6) return [[startCoords, endCoords]];

            const points = [];
            for (let i = 0; i <= numPoints; i++) {
                const f = i / numPoints;
                const A = Math.sin((1 - f) * d) / Math.sin(d);
                const B = Math.sin(f * d) / Math.sin(d);
                const x = A * Math.cos(lat1) * Math.cos(lon1) + B * Math.cos(lat2) * Math.cos(lon2);
                const y = A * Math.cos(lat1) * Math.sin(lon1) + B * Math.cos(lat2) * Math.sin(lon2);
                const z = A * Math.sin(lat1) + B * Math.sin(lat2);
                const lat = Math.atan2(z, Math.sqrt(Math.pow(x, 2) + Math.pow(y, 2)));
                const lon = Math.atan2(y, x);
                points.push([toDegrees(lat), toDegrees(lon)]);
            }

            const lines = [];
            let currentLine = [];
            for (let i = 0; i < points.length; i++) {
                currentLine.push(points[i]);
                if (i > 0 && Math.abs(points[i][1] - points[i - 1][1]) > 180) {
                    const lastPoint = points[i - 1];
                    const thisPoint = points[i];
                    const lonDiff = thisPoint[1] - lastPoint[1];
                    const direction = lonDiff > 0 ? -1 : 1;
                    const lonEdge = 180 * direction;
                    const latAtEdge = lastPoint[0] + (lonEdge - lastPoint[1]) * (thisPoint[0] - lastPoint[0]) / lonDiff;

                    currentLine[currentLine.length - 1] = [latAtEdge, lonEdge];
                    lines.push(currentLine);
                    currentLine = [[latAtEdge, -lonEdge], thisPoint];
                }
            }
            lines.push(currentLine);
            return lines;
        }


        // --- Map Initialization and Drawing ---
        function initializeMap() {
            map = L.map('flightMap', {
                worldCopyJump: true // Ensures continuous panning
            }).setView([20, 0], 2);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
                // noWrap: true was removed to allow the map to repeat horizontally
            }).addTo(map);

            drawFlightsOnMap();
        }

        function drawFlightsOnMap() {
            flightLayers.forEach(layer => map.removeLayer(layer));
            flightLayers = [];
            const visibleFlights = flightsData.filter(f => !f.is_skiplagged);

            // Group flights by route (bidirectional)
            const routeGroups = {};

            visibleFlights.forEach(flight => {
                if (flight.origin_coords && flight.dest_coords) {
                    // Create a normalized route key that treats A→B and B→A as the same route
                    const routeKey = [flight.origin, flight.destination].sort().join('-');

                    if (!routeGroups[routeKey]) {
                        routeGroups[routeKey] = {
                            flights: [],
                            coords: {
                                origin: flight.origin_coords,
                                destination: flight.dest_coords
                            },
                            airports: {
                                origin: flight.origin,
                                destination: flight.destination
                            }
                        };
                    }

                    routeGroups[routeKey].flights.push(flight);
                }
            });

            // Draw consolidated routes
            Object.entries(routeGroups).forEach(([routeKey, routeData]) => {
                const { flights, coords, airports } = routeData;

                // Use coordinates from the first flight for drawing the route
                const flightPaths = getGreatCircleArc(coords.origin, coords.destination);

                // Create tooltip content with all flights on this route
                const flightsByDirection = {
                    forward: flights.filter(f => f.origin === airports.origin),
                    reverse: flights.filter(f => f.origin === airports.destination)
                };

                let tooltipContent = `<div style="max-width: 300px;">`;

                // Forward direction flights
                if (flightsByDirection.forward.length > 0) {
                    tooltipContent += `<div><b>${airports.origin} → ${airports.destination}</b></div>`;
                    flightsByDirection.forward.forEach(flight => {
                        const date = flight.departure_date || 'Unknown date';
                        tooltipContent += `<div style="margin-left: 10px; font-size: 12px;">${flight.carrier} ${flight.flight_number} (${date})</div>`;
                    });
                }

                // Reverse direction flights
                if (flightsByDirection.reverse.length > 0) {
                    if (flightsByDirection.forward.length > 0) {
                        tooltipContent += `<div style="margin-top: 8px;"><b>${airports.destination} → ${airports.origin}</b></div>`;
                    } else {
                        tooltipContent += `<div><b>${airports.destination} → ${airports.origin}</b></div>`;
                    }
                    flightsByDirection.reverse.forEach(flight => {
                        const date = flight.departure_date || 'Unknown date';
                        tooltipContent += `<div style="margin-left: 10px; font-size: 12px;">${flight.carrier} ${flight.flight_number} (${date})</div>`;
                    });
                }

                tooltipContent += `<div style="margin-top: 8px; font-size: 11px; color: #888;">Total flights: ${flights.length}</div>`;
                tooltipContent += `</div>`;

                // Determine line weight based on number of flights
                const lineWeight = Math.min(2 + flights.length * 0.5, 6);
                const lineColor = flights.length > 1 ? '#DC2626' : '#2563EB'; // Red for busy routes (more than 1 flight), blue for single

                flightPaths.forEach(path => {
                    // Draw the path on 3 world copies for seamless wrapping
                    [-360, 0, 360].forEach(lonOffset => {
                        const shiftedPath = path.map(point => [point[0], point[1] + lonOffset]);
                        const polyline = L.polyline(shiftedPath, {
                            color: lineColor,
                            weight: lineWeight,
                            opacity: 0.7
                        }).addTo(map);
                        polyline.bindTooltip(tooltipContent, {
                            sticky: true,
                            className: 'flight-route-tooltip'
                        });
                        flightLayers.push(polyline);
                    });
                });
            });
        }

        // --- Source Display Helpers ---
        function getSourceDisplay(flight) {
            const sourceFile = flight.source_file || 'Unknown';

            // Pasted Data - clickable to show raw data
            if (sourceFile === 'Pasted Data' && flight.raw_data) {
                return `<span class="text-cyan-400 hover:text-cyan-300 cursor-pointer underline" onclick="event.stopPropagation(); showSourceModal('raw', '${encodeURIComponent(flight.raw_data)}', '${flight.carrier} ${flight.flight_number}')">Pasted Data</span>`;
            }

            // Camera Scan - not clickable
            if (sourceFile === 'Camera Scan') {
                return `<span class="text-gray-400">Camera Scan</span>`;
            }

            // Image file - clickable to show image
            if (sourceFile.match(/\.(png|jpg|jpeg|gif|bmp|webp|tiff?)$/i)) {
                return `<span class="text-blue-400 hover:text-blue-300 cursor-pointer underline" onclick="event.stopPropagation(); showSourceModal('image', '${sourceFile}', '${flight.carrier} ${flight.flight_number}')">${sourceFile}</span>`;
            }

            // Default - just show the text
            return sourceFile;
        }

        function showSourceModal(type, data, flightInfo) {
            let modalContent = '';

            if (type === 'raw') {
                const rawData = decodeURIComponent(data);
                modalContent = `
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-white">Raw Barcode Data</h3>
                                <p class="text-gray-400 text-sm">${flightInfo}</p>
                            </div>
                            <button type="button" onclick="closeSourceModal()" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                        </div>
                        <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto">
                            <pre class="text-cyan-300 font-mono text-sm whitespace-pre-wrap break-all">${rawData}</pre>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button onclick="navigator.clipboard.writeText('${rawData.replace(/'/g, "\\'")}'); this.textContent='Copied!'; setTimeout(() => this.textContent='Copy to Clipboard', 2000)" 
                                class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">
                                Copy to Clipboard
                            </button>
                        </div>
                    </div>
                `;
            } else if (type === 'image') {
                modalContent = `
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-white">Source Image</h3>
                                <p class="text-gray-400 text-sm">${flightInfo} - ${data}</p>
                            </div>
                            <button type="button" onclick="closeSourceModal()" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                        </div>
                        <div class="bg-gray-900 rounded-lg p-2 overflow-hidden">
                            <img src="/passes/${data}" alt="Source boarding pass" class="max-w-full h-auto rounded" onerror="this.parentElement.innerHTML='<p class=\\'text-red-400 p-4\\'>Image not found: ${data}<br><span class=\\'text-gray-400 text-sm\\'>(the source image may have been deleted)</span></p>'" />
                        </div>
                    </div>
                `;
            }

            const modal = document.getElementById('source-modal');
            const backdrop = document.getElementById('source-modal-backdrop');
            modal.innerHTML = modalContent;
            backdrop.classList.remove('hidden');
            backdrop.classList.add('flex');
            setTimeout(() => {
                backdrop.classList.add('opacity-100');
                modal.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeSourceModal() {
            const modal = document.getElementById('source-modal');
            const backdrop = document.getElementById('source-modal-backdrop');
            backdrop.classList.remove('opacity-100');
            modal.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                backdrop.classList.add('hidden');
                backdrop.classList.remove('flex');
            }, 300);
        }

        // --- Details Modal ---
        function openModal(flightId) {
            const flight = flightsData.find(f => f.id === flightId);
            if (!flight) return;
            let modalContent = `
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-2xl font-bold text-white">${flight.carrier} ${flight.flight_number}</h3>
                            <p class="text-gray-400">${flight.origin} → ${flight.destination}</p>
                        </div>
                        <button type="button" onclick="closeModal()" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                    </div>
                    <div class="space-y-4 text-gray-300">
                        <div class="grid grid-cols-2 gap-4">
                            <div><strong>Passenger:</strong> ${flight.passenger_name}</div>
                            <div><strong>Seat:</strong> ${flight.seat_number}</div>
                            <div><strong>Scheduled Date:</strong> ${flight.departure_date}</div>
                            <div><strong>Confirmation:</strong> <span class="font-mono">${flight.confirmation_number}</span></div>
                            <div><strong>Cabin:</strong> ${flight.cabin}</div>
                            <div><strong>Source:</strong> ${getSourceDisplay(flight)}</div>
                        </div>
                        <div class="pt-4 border-t border-gray-700">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                                <div><strong>Scheduled Departure:</strong> ${flight.scheduled_departure_time ? formatTimeWithTimezone(flight.scheduled_departure_time) : 'N/A'}</div>
                                <div><strong>Actual Departure:</strong> ${flight.actual_departure_time ? formatTimeWithTimezone(flight.actual_departure_time) : 'N/A'}</div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><strong>Scheduled Arrival:</strong> ${flight.scheduled_arrival_time ? formatTimeWithTimezone(flight.scheduled_arrival_time) : 'N/A'}</div>
                                <div><strong>Actual Arrival:</strong> ${flight.actual_arrival_time ? formatTimeWithTimezone(flight.actual_arrival_time) : 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                    `;

            if (flight.flightera_link) {
                modalContent += `
                    <div class="pt-4 border-t border-gray-700 flex gap-2">
                        <a href="${flight.flightera_link}" target="_blank" rel="noopener noreferrer" class="flex-1 text-center bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">
                            View on Flightera
                        </a>
                        <button onclick="openFlighteraUpdateModal('${flight.id}')" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">
                            Update Times
                        </button>
                    </div>`;
            } else {
                modalContent += `
                    <div class="pt-4 border-t border-gray-700">
                        <button onclick="openFlighteraUpdateModal('${flight.id}')" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">
                            Add Flightera Data
                        </button>
                    </div>`;
            }

            modalContent += `
                        <div class="pt-4 mt-4 border-t border-gray-700">
                            <button 
                                id="skiplag-toggle-btn-${flight.id}" 
                                onclick="toggleSkiplagStatus('${flight.id}')" 
                                class="w-full font-bold py-2 px-4 rounded-md transition-colors duration-200 ${flight.is_skiplagged ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-gray-600 hover:bg-gray-700'}">
                                ${flight.is_skiplagged ? 'Mark as Not Skiplagged' : 'Mark as Skiplagged'}
                            </button>
                        </div>
                        <div class="pt-2">
                            <button 
                                onclick="confirmDeleteFlight('${flight.id}', '${flight.carrier} ${flight.flight_number}', '${flight.origin}', '${flight.destination}')" 
                                class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200">
                                Delete Flight
                            </button>
                        </div>
                    </div>
                </div>
            `;
            const modal = document.getElementById('details-modal');
            const backdrop = document.getElementById('details-modal-backdrop');
            modal.innerHTML = modalContent;
            backdrop.classList.remove('hidden');
            backdrop.classList.add('flex');
            setTimeout(() => {
                backdrop.classList.add('opacity-100');
                modal.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('details-modal');
            const backdrop = document.getElementById('details-modal-backdrop');
            backdrop.classList.remove('opacity-100');
            modal.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                backdrop.classList.add('hidden');
                backdrop.classList.remove('flex');
            }, 300);
        }

        // --- Raw Data Entry Modal ---
        function openRawDataModal() {
            const backdrop = document.getElementById('raw-data-modal-backdrop');
            const modal = document.getElementById('raw-data-modal');

            // Reset form state
            document.getElementById('raw-data-form').reset();
            document.getElementById('raw-data-error-msg').classList.add('hidden');
            document.getElementById('raw-data-success-msg').classList.add('hidden');

            backdrop.classList.remove('hidden');
            backdrop.classList.add('flex');
            setTimeout(() => {
                backdrop.classList.add('opacity-100');
                modal.classList.remove('scale-95', 'opacity-0');
                document.getElementById('raw-data-input').focus();
            }, 10);
        }

        function closeRawDataModal() {
            const backdrop = document.getElementById('raw-data-modal-backdrop');
            const modal = document.getElementById('raw-data-modal');
            backdrop.classList.remove('opacity-100');
            modal.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                backdrop.classList.add('hidden');
                backdrop.classList.remove('flex');
                document.getElementById('raw-data-form').reset();
                document.getElementById('raw-data-error-msg').classList.add('hidden');
                document.getElementById('raw-data-success-msg').classList.add('hidden');
            }, 300);
        }

        async function handleRawDataSubmit(event) {
            event.preventDefault();

            const rawData = document.getElementById('raw-data-input').value.trim();
            const submitBtn = document.getElementById('raw-data-submit-btn');
            const btnText = document.getElementById('raw-data-btn-text');
            const spinner = document.getElementById('raw-data-spinner');
            const errorMsg = document.getElementById('raw-data-error-msg');
            const errorText = document.getElementById('raw-data-error-text');
            const successMsg = document.getElementById('raw-data-success-msg');
            const successText = document.getElementById('raw-data-success-text');

            // Hide previous messages
            errorMsg.classList.add('hidden');
            successMsg.classList.add('hidden');

            // Show loading state
            submitBtn.disabled = true;
            btnText.textContent = 'Processing...';
            spinner.classList.remove('hidden');

            try {
                const response = await fetch('/api/process_scanned_pass', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ raw_data: rawData, source: 'Pasted Data' })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to process data');
                }

                if (result.success) {
                    // Show success message briefly then reload
                    successText.textContent = result.message || `Successfully processed ${result.flights?.length || 0} flight(s)!`;
                    successMsg.classList.remove('hidden');

                    setTimeout(() => {
                        closeRawDataModal();
                        window.location.reload();
                    }, 1500);
                } else {
                    throw new Error(result.error || 'Unknown error occurred');
                }
            } catch (error) {
                console.error('Error processing raw data:', error);
                errorText.textContent = error.message;
                errorMsg.classList.remove('hidden');
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                btnText.textContent = 'Process Data';
                spinner.classList.add('hidden');
            }
        }

        // --- Delete Flight ---
        async function confirmDeleteFlight(flightId, flightName, origin, destination) {
            const confirmed = confirm(`Are you sure you want to delete ${flightName} (${origin} → ${destination})?\n\nThis action cannot be undone.`);

            if (!confirmed) return;

            try {
                const response = await fetch('/api/delete_flight', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: flightId })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to delete flight');
                }

                if (result.success) {
                    closeModal();
                    window.location.reload();
                } else {
                    throw new Error(result.error || 'Unknown error occurred');
                }
            } catch (error) {
                console.error('Error deleting flight:', error);
                alert(`Could not delete flight: ${error.message}`);
            }
        }

        // --- Add Trip Modal ---
        function openAddTripModal() {
            const backdrop = document.getElementById('add-trip-modal-backdrop');
            const modal = document.getElementById('add-trip-modal');
            backdrop.classList.remove('hidden');
            backdrop.classList.add('flex');
            setTimeout(() => {
                backdrop.classList.add('opacity-100');
                modal.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeAddTripModal() {
            const backdrop = document.getElementById('add-trip-modal-backdrop');
            const modal = document.getElementById('add-trip-modal');
            backdrop.classList.remove('opacity-100');
            modal.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                backdrop.classList.add('hidden');
                backdrop.classList.remove('flex');
                document.getElementById('add-trip-form').reset();
            }, 300);
        }

        async function handleAddTripSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const flightData = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/api/add_flight', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(flightData)
                });

                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.error || 'Failed to add flight');
                }
                closeAddTripModal();
                window.location.reload(); // Reload to see the new flight
            } catch (error) {
                console.error('Error adding flight:', error);
                alert(`Could not add flight: ${error.message}`);
            }
        }

        // --- Time Formatting with Timezone ---
        function formatTimeWithTimezone(timeString) {
            // Display time in the FLIGHT's local timezone, not the viewer's timezone
            // Input format: "2025-12-30T06:30+01:00" or "2025-12-30T06:30"
            if (!timeString) return 'N/A';

            try {
                // Parse the components directly without Date conversion
                const match = timeString.match(/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})([+-]\d{2}:\d{2})?/);
                if (!match) return timeString;

                const [, year, month, day, hour, minute, tzOffset] = match;

                // Format the date nicely
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const monthName = months[parseInt(month) - 1];

                // Build display string with the flight's local time
                let display = `${monthName} ${parseInt(day)}, ${year} ${hour}:${minute}`;

                // Add timezone offset if present
                if (tzOffset) {
                    display += ` (UTC${tzOffset})`;
                }

                return display;
            } catch (error) {
                return timeString;
            }
        }

        // --- API Call for Skiplagging ---
        async function toggleSkiplagStatus(flightId) {
            try {
                const response = await fetch('/api/toggle_skiplag', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: flightId })
                });

                if (!response.ok) throw new Error('Failed to update flight status');
                const result = await response.json();
                if (result.success) {
                    const flight = flightsData.find(f => f.id === flightId);
                    flight.is_skiplagged = result.new_status;
                    updateFlightRowUI(flightId, result.new_status);
                    updateSkiplagButtonUI(flightId, result.new_status);
                    drawFlightsOnMap();
                }
            } catch (error) {
                console.error('Error toggling skiplag status:', error);
                alert('Could not update flight status. Please check the console.');
            }
        }

        function updateFlightRowUI(flightId, isSkiplagged) {
            const row = document.getElementById(`flight-row-${flightId}`);
            if (row) {
                if (isSkiplagged) {
                    row.classList.add('text-gray-500', 'opacity-60');
                } else {
                    row.classList.remove('text-gray-500', 'opacity-60');
                }
            }
        }

        function updateSkiplagButtonUI(flightId, isSkiplagged) {
            const button = document.getElementById(`skiplag-btn-${flightId}`);
            if (button) {
                button.textContent = isSkiplagged ? 'Mark as Not Skiplagged' : 'Mark as Skiplagged';
                if (isSkiplagged) {
                    button.classList.remove('bg-red-600', 'hover:bg-red-700');
                    button.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
                } else {
                    button.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                    button.classList.add('bg-red-600', 'hover:bg-red-700');
                }
            }
        }

        // --- Auto-scrape Flightera ---
        async function autoScrapeFlightera() {
            const flighteraInput = document.getElementById('flightera_link');
            const flighteraUrl = flighteraInput.value.trim();

            if (!flighteraUrl) {
                alert('Please enter a Flightera URL first.');
                return;
            }

            if (!flighteraUrl.includes('flightera.net')) {
                alert('Please enter a valid Flightera URL.');
                return;
            }

            try {
                const response = await fetch('/api/scrape_flightera', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: flighteraUrl })
                });

                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.error || 'Failed to scrape flight data');
                }

                const result = await response.json();
                if (result.success && result.data) {
                    const data = result.data;

                    console.log('Scraped data:', data); // Debug log

                    // Fill form fields with scraped data - use more specific selectors
                    const carrierInput = document.querySelector('#add-trip-form input[name="carrier"]');
                    const flightNumberInput = document.querySelector('#add-trip-form input[name="flight_number"]');
                    const originInput = document.querySelector('#add-trip-form input[name="origin"]');
                    const destinationInput = document.querySelector('#add-trip-form input[name="destination"]');
                    const scheduledDepartureInput = document.querySelector('#add-trip-form input[name="scheduled_departure_time"]');
                    const actualDepartureInput = document.querySelector('#add-trip-form input[name="actual_departure_time"]');
                    const scheduledArrivalInput = document.querySelector('#add-trip-form input[name="scheduled_arrival_time"]');
                    const actualArrivalInput = document.querySelector('#add-trip-form input[name="actual_arrival_time"]');

                    if (data.carrier && carrierInput) {
                        carrierInput.value = data.carrier;
                        console.log('Set carrier:', data.carrier);
                    }
                    if (data.flight_number && flightNumberInput) {
                        flightNumberInput.value = data.flight_number;
                        console.log('Set flight number:', data.flight_number);
                    }
                    if (data.origin && originInput) {
                        originInput.value = data.origin;
                        console.log('Set origin:', data.origin);
                    }
                    if (data.destination && destinationInput) {
                        destinationInput.value = data.destination;
                        console.log('Set destination:', data.destination);
                    }

                    // Handle time fields - convert HH:MM format to datetime-local if needed
                    if (data.scheduled_departure_time && scheduledDepartureInput) {
                        try {
                            // If it's just time (HH:MM), we need to add a date for datetime-local input
                            let timeValue = data.scheduled_departure_time;
                            if (timeValue.match(/^\d{1,2}:\d{2}$/)) {
                                // Add today's date for datetime-local input
                                const today = new Date().toISOString().split('T')[0];
                                timeValue = `${today}T${timeValue}`;
                            }
                            scheduledDepartureInput.value = timeValue;
                            console.log('Set scheduled departure time:', timeValue);
                        } catch (e) {
                            console.error('Error setting scheduled departure time:', e);
                        }
                    }

                    if (data.actual_departure_time && actualDepartureInput) {
                        try {
                            let timeValue = data.actual_departure_time;
                            if (timeValue.match(/^\d{1,2}:\d{2}$/)) {
                                const today = new Date().toISOString().split('T')[0];
                                timeValue = `${today}T${timeValue}`;
                            }
                            actualDepartureInput.value = timeValue;
                            console.log('Set actual departure time:', timeValue);
                        } catch (e) {
                            console.error('Error setting actual departure time:', e);
                        }
                    }

                    if (data.scheduled_arrival_time && scheduledArrivalInput) {
                        try {
                            let timeValue = data.scheduled_arrival_time;
                            if (timeValue.match(/^\d{1,2}:\d{2}$/)) {
                                const today = new Date().toISOString().split('T')[0];
                                timeValue = `${today}T${timeValue}`;
                            }
                            scheduledArrivalInput.value = timeValue;
                            console.log('Set scheduled arrival time:', timeValue);
                        } catch (e) {
                            console.error('Error setting scheduled arrival time:', e);
                        }
                    }

                    if (data.actual_arrival_time && actualArrivalInput) {
                        try {
                            let timeValue = data.actual_arrival_time;
                            if (timeValue.match(/^\d{1,2}:\d{2}$/)) {
                                const today = new Date().toISOString().split('T')[0];
                                timeValue = `${today}T${timeValue}`;
                            }
                            actualArrivalInput.value = timeValue;
                            console.log('Set actual arrival time:', timeValue);
                        } catch (e) {
                            console.error('Error setting actual arrival time:', e);
                        }
                    }

                    alert(`Flight data auto-filled successfully!\nCarrier: ${data.carrier || 'N/A'}\nFlight: ${data.flight_number || 'N/A'}\nRoute: ${data.origin || 'N/A'} → ${data.destination || 'N/A'}`);
                } else {
                    throw new Error('No flight data found');
                }
            } catch (error) {
                console.error('Error scraping Flightera:', error);
                alert(`Could not auto-fill flight data: ${error.message}`);
            }
        }

        // Debug function to check form fields
        function debugFormFields() {
            const form = document.getElementById('add-trip-form');
            const inputs = form.querySelectorAll('input, select');
            console.log('Form fields:');
            inputs.forEach(input => {
                console.log(`${input.name}: ${input.value}`);
            });
        }

        // --- Flightera Update Modal ---
        function openFlighteraUpdateModal(flightId) {
            const flight = flightsData.find(f => f.id === flightId);
            if (!flight) return;

            // Close the details modal first
            closeModal();

            // Set the flight ID and info
            document.getElementById('flightera-update-flight-id').value = flightId;
            document.getElementById('flightera-update-flight-info').textContent = `${flight.carrier} ${flight.flight_number} (${flight.origin} → ${flight.destination})`;

            // Pre-fill the Flightera link if it exists
            if (flight.flightera_link) {
                document.getElementById('flightera_update_link').value = flight.flightera_link;
            }

            // Reset the form state
            document.getElementById('flightera-scraped-data').classList.add('hidden');
            document.getElementById('flightera-save-btn').disabled = true;

            // Open the modal
            const backdrop = document.getElementById('flightera-update-modal-backdrop');
            const modal = document.getElementById('flightera-update-modal');
            backdrop.classList.remove('hidden');
            backdrop.classList.add('flex');
            setTimeout(() => {
                backdrop.classList.add('opacity-100');
                modal.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeFlighteraUpdateModal() {
            const backdrop = document.getElementById('flightera-update-modal-backdrop');
            const modal = document.getElementById('flightera-update-modal');
            backdrop.classList.remove('opacity-100');
            modal.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                backdrop.classList.add('hidden');
                backdrop.classList.remove('flex');
                document.getElementById('flightera-update-form').reset();
                document.getElementById('flightera-scraped-data').classList.add('hidden');
                document.getElementById('flightera-save-btn').disabled = true;
            }, 300);
        }

        async function autoScrapeFlighteraUpdate() {
            const flighteraInput = document.getElementById('flightera_update_link');
            const flighteraUrl = flighteraInput.value.trim();
            const scrapeBtn = document.getElementById('flightera-scrape-btn');

            if (!flighteraUrl) {
                alert('Please enter a Flightera URL first.');
                return;
            }

            if (!flighteraUrl.includes('flightera.net')) {
                alert('Please enter a valid Flightera URL.');
                return;
            }

            // Show loading state
            scrapeBtn.textContent = 'Pulling...';
            scrapeBtn.disabled = true;

            try {
                const response = await fetch('/api/scrape_flightera', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: flighteraUrl })
                });

                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.error || 'Failed to scrape flight data');
                }

                const result = await response.json();
                if (result.success && result.data) {
                    const data = result.data;
                    console.log('Scraped data for update:', data);

                    // Fill the form fields
                    const scheduledDeptInput = document.getElementById('flightera_scheduled_departure_time');
                    const actualDeptInput = document.getElementById('flightera_actual_departure_time');
                    const scheduledArrInput = document.getElementById('flightera_scheduled_arrival_time');
                    const actualArrInput = document.getElementById('flightera_actual_arrival_time');
                    const depTzSelect = document.getElementById('flightera_dep_timezone');
                    const arrTzSelect = document.getElementById('flightera_arr_timezone');

                    // Extract timezone from departure times
                    let depTimezone = extractTimezone(data.actual_departure_time) || extractTimezone(data.scheduled_departure_time);
                    let arrTimezone = extractTimezone(data.actual_arrival_time) || extractTimezone(data.scheduled_arrival_time);

                    console.log('Extracted timezones:', { dep: depTimezone, arr: arrTimezone });

                    if (data.scheduled_departure_time) {
                        scheduledDeptInput.value = formatTimeForInput(data.scheduled_departure_time);
                    }
                    if (data.actual_departure_time) {
                        actualDeptInput.value = formatTimeForInput(data.actual_departure_time);
                    }
                    if (data.scheduled_arrival_time) {
                        scheduledArrInput.value = formatTimeForInput(data.scheduled_arrival_time);
                    }
                    if (data.actual_arrival_time) {
                        actualArrInput.value = formatTimeForInput(data.actual_arrival_time);
                    }

                    // Set timezone selects
                    if (depTimezone) {
                        depTzSelect.value = depTimezone;
                    }
                    if (arrTimezone) {
                        arrTzSelect.value = arrTimezone;
                    }

                    // Show the scraped data section and enable save
                    document.getElementById('flightera-scraped-data').classList.remove('hidden');
                    document.getElementById('flightera-save-btn').disabled = false;
                } else {
                    throw new Error('No flight data found');
                }
            } catch (error) {
                console.error('Error scraping Flightera:', error);
                alert(`Could not pull flight data: ${error.message}`);
            } finally {
                scrapeBtn.textContent = 'Pull Data';
                scrapeBtn.disabled = false;
            }
        }

        function extractTimezone(timeString) {
            // Extract timezone offset from ISO8601 string (e.g., "+01:00" from "2025-12-30T06:30+01:00")
            if (!timeString) return null;

            // Match timezone offset at end: +HH:MM or -HH:MM
            const match = timeString.match(/([+-]\d{2}:\d{2})$/);
            if (match) return match[1];

            // Also handle Z for UTC
            if (timeString.endsWith('Z')) return '+00:00';

            return null;
        }

        function formatTimeForInput(timeString) {
            // Convert time string to datetime-local format (YYYY-MM-DDTHH:MM)
            if (!timeString) return '';

            // If it already has 'T' in it, it might be in the right format
            if (timeString.includes('T')) {
                // Extract YYYY-MM-DDTHH:MM part
                const match = timeString.match(/(\d{4}-\d{2}-\d{2}T\d{2}:\d{2})/);
                if (match) return match[1];
            }

            // If it's just a time (HH:MM), we can't add a date
            if (timeString.match(/^\d{1,2}:\d{2}$/)) {
                return ''; // Skip time-only values for datetime-local inputs
            }

            return timeString;
        }

        async function handleFlighteraUpdateSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            const flightId = formData.get('flight_id');
            const depTimezone = formData.get('dep_timezone') || '+00:00';
            const arrTimezone = formData.get('arr_timezone') || '+00:00';

            // Helper to append timezone to datetime-local value
            function addTimezone(timeValue, timezone) {
                if (!timeValue) return null;
                // datetime-local format is YYYY-MM-DDTHH:MM, append timezone
                return `${timeValue}${timezone}`;
            }

            const updateData = {
                id: flightId,
                flightera_link: formData.get('flightera_link'),
                scheduled_departure_time: addTimezone(formData.get('scheduled_departure_time'), depTimezone),
                actual_departure_time: addTimezone(formData.get('actual_departure_time'), depTimezone),
                scheduled_arrival_time: addTimezone(formData.get('scheduled_arrival_time'), arrTimezone),
                actual_arrival_time: addTimezone(formData.get('actual_arrival_time'), arrTimezone)
            };

            console.log('Submitting flight update with timezones:', updateData);

            try {
                const response = await fetch('/api/update_flight', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });

                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.error || 'Failed to update flight');
                }

                closeFlighteraUpdateModal();
                window.location.reload(); // Reload to see the updated flight
            } catch (error) {
                console.error('Error updating flight:', error);
                alert(`Could not update flight: ${error.message}`);
            }
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeMap();
        });

        // --- Add Image Modal & Logic ---
        let selectedFiles = [];
        let currentIndex = 0;
        let cropper = null;

        function openAddImageModal() {
            const backdrop = document.getElementById('add-image-modal-backdrop');
            const modal = document.getElementById('add-image-modal');
            backdrop.classList.remove('hidden');
            backdrop.classList.add('flex');
            // Reset state
            resetUploadState();
            setTimeout(() => {
                backdrop.classList.add('opacity-100');
                modal.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeAddImageModal() {
            const backdrop = document.getElementById('add-image-modal-backdrop');
            const modal = document.getElementById('add-image-modal');
            backdrop.classList.remove('opacity-100');
            modal.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                backdrop.classList.add('hidden');
                backdrop.classList.remove('flex');
                resetUploadState();
            }, 300);
        }

        function resetUploadState() {
            selectedFiles = [];
            currentIndex = 0;
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            document.getElementById('upload-step-1').classList.remove('hidden');
            document.getElementById('upload-step-2').classList.add('hidden');
            document.getElementById('image-input').value = '';
            hideError();
        }

        function hideError() {
            const errorDiv = document.getElementById('upload-error-msg');
            if (errorDiv) errorDiv.classList.add('hidden');
        }

        function showError(msg) {
            const errorDiv = document.getElementById('upload-error-msg');
            const errorText = document.getElementById('upload-error-text');
            if (errorDiv && errorText) {
                errorText.textContent = msg;
                errorDiv.classList.remove('hidden');
            } else {
                alert(msg); // Fallback
            }
        }

        function handleDrop(event) {
            event.preventDefault();
            const files = event.dataTransfer.files;
            handleFiles(files);
        }

        function handleFileSelect(event) {
            const files = event.target.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            if (files.length === 0) return;
            selectedFiles = Array.from(files);
            currentIndex = 0;
            startProcessing();
        }

        function startProcessing() {
            if (selectedFiles.length === 0) return;

            document.getElementById('upload-step-1').classList.add('hidden');
            document.getElementById('upload-step-2').classList.remove('hidden');
            document.getElementById('total-images-num').textContent = selectedFiles.length;

            showCurrentImage();
        }

        function showCurrentImage() {
            hideError(); // Clear previous errors
            if (currentIndex >= selectedFiles.length) {
                // All done
                closeAddImageModal();
                window.location.reload();
                return;
            }

            document.getElementById('current-image-num').textContent = currentIndex + 1;
            const file = selectedFiles[currentIndex];
            const reader = new FileReader();

            reader.onload = function (e) {
                const imageElement = document.getElementById('cropper-image');
                imageElement.src = e.target.result;

                // Add constraint to ensure no scrolling inside the cropper container
                imageElement.style.maxHeight = '50vh';

                if (cropper) {
                    cropper.destroy();
                }

                // Initialize Cropper
                cropper = new Cropper(imageElement, {
                    viewMode: 1,
                    dragMode: 'move',
                    autoCropArea: 0.9, // Make crop area larger by default
                    restore: false,
                    guides: true,
                    center: true,
                    highlight: false,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: false,
                    zoomable: false, // Disable zoom as requested
                    scalable: false,
                    minContainerHeight: 300,
                });
            };

            reader.readAsDataURL(file);
        }

        async function processCurrentImage() {
            if (!cropper) return;

            const btn = document.querySelector('button[onclick="processCurrentImage()"]');
            const btnText = document.getElementById('process-btn-text');
            const spinner = document.getElementById('process-spinner');

            hideError();

            // UI Loading State
            btn.disabled = true;
            btnText.textContent = 'Processing...';
            spinner.classList.remove('hidden');

            try {
                // Get cropped canvas
                const canvas = cropper.getCroppedCanvas();
                if (!canvas) throw new Error('Could not get cropped image');

                // Convert to blob
                canvas.toBlob(async (blob) => {
                    const formData = new FormData();
                    // Preserve original extension if possible or use png
                    const originalName = selectedFiles[currentIndex].name;
                    formData.append('file', blob, originalName);

                    try {
                        const response = await fetch('/api/upload_pass', {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();

                        if (!response.ok) {
                            throw new Error(result.error || 'Upload failed');
                        }

                        // Success notification (simple alert for now, could be toast)
                        // alert('Flight processed successfully!');

                        // Move to next
                        nextImage();

                    } catch (error) {
                        console.error('Error uploading:', error);
                        // Show persistent error in UI
                        showError(`Error: ${error.message}`);
                        // Don't auto-advance on error so user can retry or skip
                    } finally {
                        // Reset UI
                        btn.disabled = false;
                        btnText.textContent = 'Crop & Parse';
                        spinner.classList.add('hidden');
                    }
                }, 'image/png');

            } catch (error) {
                console.error('Error in processing:', error);
                showError('Failed to process image.');
                btn.disabled = false;
                btnText.textContent = 'Crop & Parse';
                spinner.classList.add('hidden');
            }
        }

        function nextImage() {
            currentIndex++;
            showCurrentImage();
        }

        function skipCurrentImage() {
            nextImage();
        }
    </script>


    <script>
        // --- Camera Scanning ---
        let html5QrcodeScanner;

        function openCameraModal() {
            const backdrop = document.getElementById('camera-modal-backdrop');
            const modal = document.getElementById('camera-modal');
            backdrop.classList.remove('hidden');
            backdrop.classList.add('flex');
            setTimeout(() => {
                backdrop.classList.add('opacity-100');
                modal.classList.remove('scale-95', 'opacity-0');
            }, 10);

            // Initialize scanner with Aztec support
            // Note: html5-qrcode's scanner UI handles permission request
            if (!html5QrcodeScanner) {
                html5QrcodeScanner = new Html5QrcodeScanner(
                    "reader",
                    {
                        fps: 10,
                        // Increase resolution for better barcode reading (PDF417/Aztec are dense)
                        videoConstraints: {
                            facingMode: "environment",
                            width: { min: 640, ideal: 1920, max: 2560 },
                            height: { min: 480, ideal: 1080, max: 1440 }
                        },
                        // Make scanning box larger and responsive
                        qrbox: function (viewfinderWidth, viewfinderHeight) {
                            return {
                                width: Math.floor(viewfinderWidth * 0.8),
                                height: Math.floor(viewfinderHeight * 0.6)
                            };
                        },
                        rememberLastUsedCamera: true,
                        // Enable native barcode detector if available
                        experimentalFeatures: {
                            useBarCodeDetectorIfSupported: true
                        },
                        formatsToSupport: [
                            Html5QrcodeSupportedFormats.AZTEC,
                            Html5QrcodeSupportedFormats.QR_CODE,
                            Html5QrcodeSupportedFormats.PDF_417
                        ]
                    },
                    /* verbose= */ false);
            }
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        }

        function closeCameraModal() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear().catch(error => {
                    console.error("Failed to clear html5QrcodeScanner. ", error);
                });
            }

            const backdrop = document.getElementById('camera-modal-backdrop');
            const modal = document.getElementById('camera-modal');
            backdrop.classList.remove('opacity-100');
            modal.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                backdrop.classList.add('hidden');
                backdrop.classList.remove('flex');
            }, 300);
        }

        function onScanSuccess(decodedText, decodedResult) {
            console.log("DEBUG: Scan Success!");
            console.log("DEBUG: decodedText:", decodedText);
            console.log("DEBUG: decodedResult:", JSON.stringify(decodedResult, null, 2));

            // Stop scanning immediately
            if (html5QrcodeScanner) {
                html5QrcodeScanner.pause(true);
            }

            // Send to backend
            fetch('/api/process_scanned_pass', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ raw_data: decodedText })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        closeCameraModal();
                        // Show success message or toast
                        alert(`Successfully scanned pass for ${data.flights[0].passenger_name}!\nAdded ${data.flights.length} flight(s).`);
                        window.location.reload();
                    } else {
                        alert(`Error processing pass: ${data.error}`);
                        // Resume scanning if failed
                        if (html5QrcodeScanner) {
                            html5QrcodeScanner.resume();
                        }
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("Network error processing pass.");
                    if (html5QrcodeScanner) {
                        html5QrcodeScanner.resume();
                    }
                });
        }

        function onScanFailure(error) {
            // handle scan failure, usually better to ignore and keep scanning.
            // console.warn(`Code scan error = ${error}`);
        }
    </script>
</body>

</html>
```